@using MagFlow.BLL.Services.Interfaces
@using MagFlow.Shared.DTOs.Core
@using MagFlow.Shared.Models.Enumerators
@using MagFlow.Web.Pages.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using MudExtensions
@using MagFlow.BLL.Helpers.Auth

@implements IDisposable
@inject NavigationManager NavigationManager
@inject IUserService UserService
@inject ILocalCacheService LocalCacheService

<MudAppBar Elevation="1" Class="justify-content-center" Style="min-height: 64px; max-height: 64px;">
    <div class="d-flex">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <a href="/" style="display:inline-flex;align-items:center;gap:16px">
            <div style="width:40px;height:40px;background:#0D6EFD;border-radius:6px; display:flex;align-items:center;justify-content:center">
                <span style="color:white;font-size:20px;font-weight:700">M</span>
            </div>
            <span style="font-size:28px;font-weight:700;color:#212529">
                MagFlow
            </span>
        </a>
    </div>
    <MudSpacer />
    <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" PopoverClass="my-3">
        <ActivatorContent>
            <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Large" Color="Color.Primary"/>
        </ActivatorContent>
        <ChildContent>
            <div class="d-flex flex-column align-items-center align-self-stretch px-5 pt-3 pb-1">
                <div class="d-flex align-items-center align-self-stretch" style="gap: 16px">
                    <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Large" Color="Color.Primary" />
                    <div class="d-flex flex-column align-items-start">
                        <MudText Typo="Typo.body1" Style="color: var(--mud-palette-text-primary)">@string.Concat(_user?.FirstName ?? "", " ", _user?.LastName ?? "")</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary)">@_user?.Email</MudText>
                    </div>
                </div>
            </div>
            <MudDivider/>
            <MudMenuItem Icon="@Icons.Material.Filled.Settings" IconColor="Color.Dark" Label="@Localizer[Langs.Settings]" Href="/user/settings"/>
            <form action="Auth/Logout" method="post">
                <AntiforgeryToken />
                <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Logout" IconColor="Color.Dark" IconClass="pr-1" Class="w-100 justify-content-start d-flex mud-typography mud-typography-body1 mud-menu-item-text" Style="padding: 8px 16px 8px 20px; color: var(--mud-palette-text-primary); gap: 6px;">@Localizer[Langs.Logout]</MudButton>
            </form>
        </ChildContent>
    </MudMenu>
</MudAppBar>
<MudDrawer @bind-Open="@_drawerOpen" Elevation="1" ClipMode="DrawerClipMode.Never" Variant="DrawerVariant.Temporary">
    <MudDrawerHeader Class="p-0">
        <div class="d-flex flex-column w-100 align-items-center px-2">
            <div style="display:inline-flex; align-items:center; gap: 16px;" class="mt-3">
                <div style="width:40px;height:40px;background:#0D6EFD;border-radius:6px; display:flex;align-items:center;justify-content:center">
                    <span style="color:white;font-size:20px;font-weight:700">M</span>
                </div>
                <span style="font-size:28px;font-weight:700;color:#212529">
                    MagFlow
                </span>
            </div>
            <MudDivider Class="mt-3" Style=""/>
        </div>
    </MudDrawerHeader>
    <MudNavLink Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Start" Href="/lobby">@Localizer[Langs.StartPanel]</MudNavLink>
    @if (_user?.Roles.HasMinimumRole(AppRole.CompanyAdmin) == true)
    {
        <MudNavLink Match="NavLinkMatch.All" Icon="@Icons.Material.Outlined.SettingsApplications" Href="/company/settings">@Localizer[Langs.SettingsCompany]</MudNavLink>
    }
    @if (_user?.Roles.HasExactRole(AppRole.SuperAdmin) == true)
    {
        <MudNavLink Match="NavLinkMatch.All" Icon="@Icons.Material.Outlined.AdminPanelSettings" Href="/admin">@Localizer[Langs.AdminPanel]</MudNavLink>
    }
</MudDrawer>

@code {
    private bool _drawerOpen = false;
    private string? currentUrl;

    private UserDTO? _user;

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        _user = await UserService.GetCurrentUser();
        if(_user != null)
            await LocalCacheService.SetCurrentUser(_user);
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
